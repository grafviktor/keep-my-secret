# Keep My Secret #

[![codecov](https://codecov.io/gh/grafviktor/keep-my-secret/branch/master/graph/badge.svg?token=wrIL0tyQ5q)](https://codecov.io/gh/grafviktor/keep-my-secret)

Решение для хранения личных данных пользователей в зашифрованном виде. Поддерживаются следующие типы данных:

* Кредитная карта
* Двоичные данные (файлы, картинки, документы и прочее)
* Заметки в виде произвольного текста
* Данные входа в виде пароль / логин

Приложение состоит из 2 частей - серверной и клиентской части, которые общаются друг с другом по протоколу `HTTPS`.

## Запуск приложения ##

### Поддерживаемые переменные окружения ###

| Имя переменной | Описание                                                 | Значение по умолчанию | Пример      |
|----------------|----------------------------------------------------------|-----------------------|-------------|
| APP_SECRET     | Использется для шифрования JWT-токенов                   |                       | "my secret" |
| SERVER_ADDRESS | Хост и порт, на котором будет запущен сервер             | localhost:8080        |             |
| DSN            | Пусть к файлу базы данных                                | "./kms.db"            |             |
| TLS_CERT_PATH  | Путь к HTTPS сертификату                                 | "./tls/cert.pem"      |             |
| TLS_KEY_PATH   | Путь к ключу HTTPS сертификата                           | "./tls/key.pem"       |             |
| DOMAIN         | Домен для сессионного куки                               | localhost             |             |
| CLIENT_URL     | Путь к клиентскому приложению в адресной строке браузера | "/"                   |             |
| DEV            |                                                          | false                 |             |

## Детали реализации сервера ##

Сервер принимает и обрабатывает REST-запросы от клиентов, а также взаимодействует с хранилищем данных. Сервер работает только с использованием протокола HTTPS.

### Авторизация ###

Если пользователь предоставляет верную комбинацию логина и пароля, в ответ сервер отправляет пару JWT-токенов:

* `Access token` на основе них принимается решение о предоставлении доступа к закрытым ресурсам. Этот токен имеет малый срок жизни и содержит дату окончания действия.

* `Refresh tokens`, удостоверяют запрос на получение нового Access Token'а. Например, когда истек срок действия Access Token, клиент может отправить новый запрос на получение токена на сервер авторизации. Чтобы такой запрос был успешно выполнен, он сопровождается Refresh токеном. РRefresh Token'ы имеет долгий период действия и недоступен для браузерного JavaScript.

## Хранение данных ##

Данные хранятся а базе данных SQLite. Данная БД была выбрана исключительно из практических соображений при написании данного проекта - нет необходимости запускать дополнительные процесс сервера БД. Тем не менее проект может быть легко расширен для использования любого другого хранилища.

### Обеспечение приватности данных ###

Данные шифруются с помощью AES ключа. Ключ автоматически генерируется сервером в момент регистрации нового пользователя и неизвестен самому пользователю, также как и администратору сервера. Когда пользователь авторизовывается в системе, пароль пользователя используется для извлечения ключа шифрования данных. Ключ шифрования данных находится в памяти процесса сервера. 

Дополнительной защитой являлось бы использования комбинированного пароля для сохранения и восстановления ключа данных пользователя - комбинация секрета сервера и пароля пользователя.

### API ###

Поддерживаются два основных типа REST-запросов:

1. запросы отвечающие за аутентификацию пользователей;
2. запросы отвечающие за сохранение и извелечение данных пользователя.

Данные ответов и запросов передаются в формате JSON. Бинарные файлы передаются в части запроса с типом `multipart/form-data`.

#### Аутентификация пользователей ####

| URL                        | HTTP Method | Параметры          | Описание                        |
|----------------------------|-------------|--------------------|---------------------------------|
| /api/v1/user/register      | POST        | username, password | регистрация нового пользователя |
| /api/v1/user/login         | POST        | username, password | авторизация пользователя        |
| /api/v1/user/logout        | POST        | -                  | завершение сессии               |
| /api/v1/user/token-refresh | GET         | -                  | обновление токена доступа       |

#### Сохранение и получение объектов данных пользователя ####

| URL                       | HTTP Method | Параметры   | Описание                                         |
|---------------------------|-------------|-------------|--------------------------------------------------|
| /api/v1/secrets/          | GET         | -           | получение всех сохраненных объектов пользователя |
| /api/v1/secrets/          | POST        | см.Пример 1 | сохранения нового объекта                        |
| /api/v1/secrets/          | PUT         | см.Пример 2 | обновление (замена) существующего объекта        |
| /api/v1/secrets/{id}      | DELETE      | -           | удаление объекта                                 |
| /api/v1/secrets/file/{id} | GET         | -           | получение бинарного файла                        |

Пример 1
```json
{
  "type":"card",
  "title":"Bank card",
  "cardholder_name":"Mr. Tony Tester",
  "card_number":"1234 5678 9012 3456",
  "expiration":"2023-09-03",
  "security_code":"999",
  "note":"Карта, где деньги лежат"
}
```

Пример 2
```json
{
  "id": 33,
  "type":"card",
  "title":"Bank card",
  "cardholder_name":"Mr. Tony Tester",
  "card_number":"1234 5678 9012 3456",
  "expiration":"2023-09-03",
  "security_code":"999",
  "note":"Карта, где деньги лежат"
}
```

#### Версия сервера ####

| URL              | HTTP Method | Параметры          | Описание       |
|------------------|-------------|--------------------|----------------|
| /api/v1/version  | GET         | -                  | версия сервера |

#### Ответы сервера ####

## Клиент ##

Клиенсткая часть представляет собой SPA-приложение, которое несет в себе минимум логики (Dumb Client). Браузерный клиент легко может замененым любым другим приложением, которое может работать поверх `HTTPS`-протокола.

## Имеющиеся проблемы ##

* данные между сервером и клиентом передаются в несжатой форме;
* все криптографические операции с данными производятся на стороне сервера, что ведет к проблемам масштабируемости
* ... и другие неисчислимые возможности по улучшению